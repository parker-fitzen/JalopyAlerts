<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jalopy Jungle — Multi‑Yard Inventory Search & Alerts</title>
  <style>
    :root { color-scheme: light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 0; background: #f7f7f8; }
    header { padding: 18px 16px; background: #111827; color: #fff; }
    header h1 { margin: 0; font-size: 18px; font-weight: 700; }
    header p { margin: 6px 0 0; font-size: 13px; opacity: 0.85; }

    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .grid { display: grid; gap: 12px; }
    .grid.controls { grid-template-columns: repeat(12, 1fr); align-items: end; }
    .col-12 { grid-column: span 12; }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    .col-3 { grid-column: span 3; }
    .col-2 { grid-column: span 2; }
    .col-1 { grid-column: span 1; }

    @media (max-width: 900px) {
      .col-6, .col-4, .col-3, .col-2, .col-1 { grid-column: span 12; }
    }

    label { display: block; font-size: 12px; font-weight: 600; margin: 0 0 6px; color: #111827; }
    select, input { width: 100%; padding: 10px 10px; border-radius: 10px; border: 1px solid #d1d5db; background: #fff; font-size: 14px; }
    input[type="number"] { appearance: textfield; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

    button { cursor: pointer; padding: 10px 12px; border-radius: 10px; border: 1px solid #111827; background: #111827; color: #fff; font-weight: 700; font-size: 14px; }
    button.secondary { background: #fff; color: #111827; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .status { font-size: 13px; color: #374151; }
    .status small { color: #6b7280; }

    .pillbar { display: flex; flex-wrap: wrap; gap: 8px; }
    .pill { font-size: 12px; border: 1px solid #e5e7eb; background: #fafafa; padding: 6px 10px; border-radius: 999px; }

    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid #eee; font-size: 13px; }
    th { font-size: 12px; color: #111827; background: #fafafa; position: sticky; top: 0; }

    .muted { color: #6b7280; }
    .err { color: #b91c1c; }
    .ok { color: #047857; }
    .footer-note { margin-top: 10px; font-size: 12px; color: #6b7280; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Jalopy Jungle — Multi‑Yard Inventory Search & Alerts</h1>
      <p>Search across all yards and filter by year range.</p>
      <p>Set Up alerts for new arivals.</p>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="grid controls">
        <div class="col-4">
          <label for="make">Make</label>
          <select id="make" disabled>
            <option value="">Loading makes…</option>
          </select>
        </div>

        <div class="col-4">
          <label for="model">Model</label>
          <select id="model" disabled>
            <option value="">Select a make first</option>
          </select>
        </div>

        <div class="col-2">
          <label for="minYear">Min year</label>
          <input id="minYear" type="number" inputmode="numeric" placeholder="e.g. 2005" />
        </div>

        <div class="col-2">
          <label for="maxYear">Max year</label>
          <input id="maxYear" type="number" inputmode="numeric" placeholder="e.g. 2015" />
        </div>

        <div class="col-12 row">
          <button id="searchBtn" disabled>Search all yards</button>
          <button id="resetBtn" class="secondary">Reset</button>
          <span id="status" class="status"></span>
        </div>

        <div class="col-12">
          <div id="yardCounts" class="pillbar"></div>
        </div>

        <div class="col-12 row">
          <div style="min-width: 220px; flex: 1;">
            <label for="quickFilter">Quick filter (contains)</label>
            <input id="quickFilter" placeholder="type to filter displayed rows…" />
          </div>
          <div style="min-width: 220px;">
            <label for="sort">Sort</label>
            <select id="sort">
              <option value="year_desc">Year (newest first)</option>
              <option value="year_asc">Year (oldest first)</option>
              <option value="yard_asc">Yard (A→Z)</option>
              <option value="yard_desc">Yard (Z→A)</option>
            </select>
          </div>
        </div>
      </div>

      <div style="margin-top: 12px; max-height: 56vh; overflow: auto; border-radius: 12px; border: 1px solid #eee;">
        <table>
          <thead>
            <tr>
              <th style="min-width: 75px;">YARD</th>
              <th style="min-width: 40px;">YEAR</th>
              <th style="min-width: 100px;">MAKE</th>
              <th style="min-width: 120px;">MODEL</th>
              <th style="min-width: 40px;">ROW</th>
            </tr>
          </thead>
          <tbody id="results">
            <tr><td class="muted" colspan="5">Load makes, select a make/model, then search.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="footer-note">
        Note: This fans out requests (one per yard). Keep usage reasonable so you don’t get your proxy or the upstream site blocked.
      </div>
    </div>
  </main>

  <script>
    // Your deployed proxy Worker
    const BASE = "https://jalprox.parkfitz.workers.dev";

    // Yard list (name + ID) from the upstream page
    const YARDS = [
      { id: "1020", name: "BOISE" },
      { id: "1021", name: "CALDWELL" },
      { id: "1119", name: "GARDEN CITY" },
      { id: "1022", name: "NAMPA" },
      { id: "1099", name: "TWIN FALLS" },
    ];

    const els = {
      make: document.getElementById("make"),
      model: document.getElementById("model"),
      minYear: document.getElementById("minYear"),
      maxYear: document.getElementById("maxYear"),
      searchBtn: document.getElementById("searchBtn"),
      resetBtn: document.getElementById("resetBtn"),
      status: document.getElementById("status"),
      results: document.getElementById("results"),
      yardCounts: document.getElementById("yardCounts"),
      quickFilter: document.getElementById("quickFilter"),
      sort: document.getElementById("sort"),
    };

    // In-memory caches
    let makesCache = null; // string[]
    const modelsCache = new Map(); // make -> string[]

    // Last full result set (unfiltered by quick filter)
    let lastRows = [];

    // Simple polite concurrency limiter
    async function runPool(tasks, limit = 2, delayMs = 120) {
      const results = new Array(tasks.length);
      let idx = 0;

      async function worker() {
        while (true) {
          const i = idx++;
          if (i >= tasks.length) return;
          try {
            results[i] = await tasks[i]();
          } catch (e) {
            results[i] = { ok: false, error: e };
          }
          if (delayMs) await new Promise(r => setTimeout(r, delayMs));
        }
      }

      const workers = Array.from({ length: Math.max(1, Math.min(limit, tasks.length)) }, () => worker());
      await Promise.all(workers);
      return results;
    }

    function setStatus(msg, kind = "") {
      els.status.className = "status" + (kind ? " " + kind : "");
      els.status.textContent = msg;
    }

    function clearResults(message = "") {
      els.results.innerHTML = "";
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.className = "muted";
      td.textContent = message || "No results.";
      tr.appendChild(td);
      els.results.appendChild(tr);
    }

    function formBody(obj) {
      const p = new URLSearchParams();
      for (const [k, v] of Object.entries(obj)) {
        if (v === undefined || v === null) continue;
        const s = String(v).trim();
        if (s === "") continue;
        p.set(k, s);
      }
      return p;
    }

    async function postJson(path, bodyObj) {
      const r = await fetch(BASE + path, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8" },
        body: formBody(bodyObj),
      });
      if (!r.ok) throw new Error(`${path} failed: ${r.status}`);
      return await r.json();
    }

    async function postHtml(path, bodyObj) {
      const r = await fetch(BASE + path, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8", "Accept": "text/html" },
        body: formBody(bodyObj),
      });
      if (!r.ok) throw new Error(`${path} failed: ${r.status}`);
      return await r.text();
    }

    function parseInventoryHtml(html) {
      // DOM parsing is more robust than regex.
      const doc = new DOMParser().parseFromString(html, "text/html");
      const table = doc.querySelector("table.table");
      if (!table) return [];
      const trs = Array.from(table.querySelectorAll("tr"));
      const rows = [];
      for (const tr of trs) {
        const tds = tr.querySelectorAll("td");
        if (!tds || tds.length < 4) continue;
        const year = Number((tds[0].textContent || "").trim());
        const make = (tds[1].textContent || "").trim();
        const model = (tds[2].textContent || "").trim();
        const row = (tds[3].textContent || "").trim();
        if (!year || !make || !model) continue;
        rows.push({ year, make, model, row });
      }
      return rows;
    }

    function normalizeYear(v) {
      const n = Number(String(v || "").trim());
      return Number.isFinite(n) && n > 0 ? n : null;
    }

    function applyFiltersAndRender() {
      const q = (els.quickFilter.value || "").trim().toUpperCase();
      const minY = normalizeYear(els.minYear.value);
      const maxY = normalizeYear(els.maxYear.value);

      let rows = lastRows.slice();

      // Year filtering
      if (minY !== null) rows = rows.filter(r => r.year >= minY);
      if (maxY !== null) rows = rows.filter(r => r.year <= maxY);

      // Quick filter (yard/make/model/row)
      if (q) {
        rows = rows.filter(r => {
          const hay = `${r.yardName} ${r.make} ${r.model} ${r.row} ${r.year}`.toUpperCase();
          return hay.includes(q);
        });
      }

      // Sort
      const sort = els.sort.value;
      rows.sort((a, b) => {
        if (sort === "year_desc") return b.year - a.year;
        if (sort === "year_asc") return a.year - b.year;
        if (sort === "yard_asc") return a.yardName.localeCompare(b.yardName) || (b.year - a.year);
        if (sort === "yard_desc") return b.yardName.localeCompare(a.yardName) || (b.year - a.year);
        return 0;
      });

      renderRows(rows);
      renderYardCounts(rows);

      if (!rows.length) setStatus("0 results after filters.", "");
      else setStatus(`${rows.length} result(s) shown.`, "ok");
    }

    function renderRows(rows) {
      els.results.innerHTML = "";
      if (!rows.length) {
        clearResults("No matches.");
        return;
      }
      const frag = document.createDocumentFragment();
      for (const r of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.yardName)}</td>
          <td>${escapeHtml(String(r.year))}</td>
          <td>${escapeHtml(r.make)}</td>
          <td>${escapeHtml(r.model)}</td>
          <td>${escapeHtml(r.row)}</td>
        `;
        frag.appendChild(tr);
      }
      els.results.appendChild(frag);
    }

    function renderYardCounts(rows) {
      const counts = new Map();
      for (const y of YARDS) counts.set(y.name, 0);
      for (const r of rows) counts.set(r.yardName, (counts.get(r.yardName) || 0) + 1);

      els.yardCounts.innerHTML = "";
      const frag = document.createDocumentFragment();
      for (const y of YARDS) {
        const div = document.createElement("div");
        div.className = "pill";
        div.textContent = `${y.name}: ${counts.get(y.name) || 0}`;
        frag.appendChild(div);
      }
      els.yardCounts.appendChild(frag);
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function loadMakesAllYards() {
      setStatus("Loading makes across yards…");
      els.make.disabled = true;
      els.model.disabled = true;
      els.searchBtn.disabled = true;

      const tasks = YARDS.map(y => async () => {
        const data = await postJson("/Home/GetMakes", { yardId: y.id });
        const makes = Array.isArray(data) ? data.map(x => (x && x.makeName ? String(x.makeName).trim() : "")).filter(Boolean) : [];
        return { ok: true, yard: y, makes };
      });

      const res = await runPool(tasks, 2, 120);
      const set = new Set();
      let okCount = 0;
      let failCount = 0;

      for (const r of res) {
        if (r && r.ok) {
          okCount++;
          for (const m of r.makes) set.add(m);
        } else {
          failCount++;
        }
      }

      makesCache = Array.from(set).sort((a, b) => a.localeCompare(b));

      // Populate Make dropdown
      els.make.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Select make";
      els.make.appendChild(opt0);
      for (const m of makesCache) {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        els.make.appendChild(opt);
      }

      els.make.disabled = false;
      els.model.innerHTML = '<option value="">Select a make first</option>';
      els.model.disabled = true;
      els.searchBtn.disabled = true;

      if (failCount) setStatus(`Makes loaded (some yards failed: ${failCount}).`, "");
      else setStatus(`Makes loaded from ${okCount} yard(s).`, "ok");

      clearResults("Select a make/model, then search.");
      els.yardCounts.innerHTML = "";
    }

    async function loadModelsAllYards(make) {
      if (!make) {
        els.model.innerHTML = '<option value="">Select a make first</option>';
        els.model.disabled = true;
        els.searchBtn.disabled = true;
        return;
      }

      if (modelsCache.has(make)) {
        populateModels(modelsCache.get(make));
        return;
      }

      setStatus(`Loading models for ${make}…`);
      els.model.disabled = true;
      els.searchBtn.disabled = true;
      els.model.innerHTML = '<option value="">Loading…</option>';

      const tasks = YARDS.map(y => async () => {
        const data = await postJson("/Home/GetModels", { yardId: y.id, makeName: make });
        const models = Array.isArray(data) ? data.map(x => (x && x.model ? String(x.model).trim() : "")).filter(Boolean) : [];
        return { ok: true, yard: y, models };
      });

      const res = await runPool(tasks, 2, 120);
      const set = new Set();
      let failCount = 0;

      for (const r of res) {
        if (r && r.ok) {
          for (const m of r.models) set.add(m);
        } else {
          failCount++;
        }
      }

      const models = Array.from(set).sort((a, b) => a.localeCompare(b));
      modelsCache.set(make, models);
      populateModels(models);

      if (failCount) setStatus(`Models loaded (some yards failed: ${failCount}).`, "");
      else setStatus("Models loaded.", "ok");
    }

    function populateModels(models) {
      els.model.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Any model";
      els.model.appendChild(opt0);
      for (const m of models) {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        els.model.appendChild(opt);
      }
      els.model.disabled = false;
      els.searchBtn.disabled = false;
    }

    async function searchAllYards() {
      const make = (els.make.value || "").trim();
      const model = (els.model.value || "").trim();

      if (!make) {
        setStatus("Pick a make first.", "err");
        return;
      }

      const minY = normalizeYear(els.minYear.value);
      const maxY = normalizeYear(els.maxYear.value);
      if (minY !== null && maxY !== null && minY > maxY) {
        setStatus("Year range is backwards (min > max).", "err");
        return;
      }

      setStatus("Searching all yards…");
      els.searchBtn.disabled = true;
      clearResults("Searching…");
      els.yardCounts.innerHTML = "";

      const tasks = YARDS.map(y => async () => {
        const html = await postHtml("/", {
          YardId: y.id,
          VehicleMake: make,
          VehicleModel: model || "", // blank allowed
        });
        const rows = parseInventoryHtml(html).map(r => ({
          ...r,
          yardId: y.id,
          yardName: y.name,
        }));
        return { ok: true, yard: y, rows };
      });

      const res = await runPool(tasks, 2, 150);
      const allRows = [];
      const failures = [];

      for (const r of res) {
        if (r && r.ok) allRows.push(...r.rows);
        else failures.push(r);
      }

      lastRows = allRows;
      els.searchBtn.disabled = false;

      if (!allRows.length) {
        setStatus(failures.length ? `No results (and ${failures.length} yard(s) failed).` : "No results.", failures.length ? "" : "");
        clearResults("No matches returned from any yard.");
        renderYardCounts([]);
        return;
      }

      if (failures.length) setStatus(`Fetched ${allRows.length} raw rows. (${failures.length} yard(s) failed.)`, "");
      else setStatus(`Fetched ${allRows.length} raw rows.`, "ok");

      // Apply year range + quick filter + sort and render.
      applyFiltersAndRender();
    }

    // Event wiring
    els.make.addEventListener("change", async () => {
      const make = (els.make.value || "").trim();
      els.quickFilter.value = "";
      lastRows = [];
      clearResults("Loading models…");
      els.yardCounts.innerHTML = "";
      await loadModelsAllYards(make);
      clearResults("Select a model (or Any), then search.");
    });

    els.model.addEventListener("change", () => {
      els.quickFilter.value = "";
      lastRows = [];
      clearResults("Ready to search.");
      els.yardCounts.innerHTML = "";
    });

    els.searchBtn.addEventListener("click", () => searchAllYards());

    els.resetBtn.addEventListener("click", async () => {
      els.minYear.value = "";
      els.maxYear.value = "";
      els.quickFilter.value = "";
      els.sort.value = "year_desc";
      modelsCache.clear();
      lastRows = [];
      els.make.value = "";
      els.model.innerHTML = '<option value="">Select a make first</option>';
      els.model.disabled = true;
      els.searchBtn.disabled = true;
      clearResults("Reset. Select a make.");
      els.yardCounts.innerHTML = "";
      setStatus("Reset.");
    });

    els.quickFilter.addEventListener("input", () => {
      if (!lastRows.length) return;
      applyFiltersAndRender();
    });

    els.sort.addEventListener("change", () => {
      if (!lastRows.length) return;
      applyFiltersAndRender();
    });

    // If user edits year range after search, re-filter instantly
    els.minYear.addEventListener("input", () => { if (lastRows.length) applyFiltersAndRender(); });
    els.maxYear.addEventListener("input", () => { if (lastRows.length) applyFiltersAndRender(); });

    // Boot
    (async function init() {
      try {
        await loadMakesAllYards();
      } catch (e) {
        setStatus("Failed to load makes. Check Worker URL + CORS.", "err");
        els.make.disabled = true;
        els.model.disabled = true;
        els.searchBtn.disabled = true;
        clearResults("Error loading makes.");
        console.error(e);
      }
    })();
  </script>
</body>
</html>
